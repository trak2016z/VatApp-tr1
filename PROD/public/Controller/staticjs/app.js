angular.module("VatApp",["ngRoute"]),angular.module("VatApp").config(["$routeProvider","$locationProvider",function(t,e){e.html5Mode({enabled:!0}),t.when("/",{controller:"PostsCtrl",templateUrl:"pages/posty.html"}).when("/register",{controller:"RegisterCtrl",templateUrl:"pages/register.html"}).when("/login",{controller:"LoginCtrl",templateUrl:"pages/login.html"}).when("/invoice/step4/:iId",{controller:"InvoiceStep4Ctrl",templateUrl:"pages/invoice_step4.html"}).when("/invoice/step3/:dId/:bId",{controller:"InvoiceStep3Ctrl",templateUrl:"pages/invoice_step3.html"}).when("/invoice/:dId/:bId",{controller:"InvoiceStep2Ctrl",templateUrl:"pages/invoice_step2.html"}).when("/invoice",{controller:"InvoiceCtrl",templateUrl:"pages/invoice_start.html"}).when("/users",{controller:"UsersCtrl",templateUrl:"pages/users.html"}).when("/addCompany",{controller:"CompCtrl",templateUrl:"pages/addCompany.html"})}]),angular.module("VatApp").controller("ApplicationCtrl",["$scope","UserSvc","$window","$location",function(t,e,n,a){n.localStorage.getItem("Token_jwt")&&e.getLogUser(n.localStorage.getItem("Token_jwt")).then(function(e){t.currentUser=e.data}),t.$on("login",function(e,n){t.currentUser=n}),t.logOut=function(){e.logOut(),t.currentUser=null}}]),angular.module("VatApp").controller("CompCtrl",["$scope","CompSvc","$location","$window",function(t,e,n,a){if(a.localStorage.getItem("Token_jwt")){var o;e.getAllCompany().success(function(e){t.firms?t.firms=t.firms.concat(e):t.firms=e}).error(function(t){console.log("Błąd: "+t)}),t.addFirm=function(){t.currentUser&&t.dataSetFirm.company_name&&(t.dataSetFirm.company_adress=t.dataSetFirm.company_adr1+" "+t.dataSetFirm.company_adr2,e.createCompany({body:t.dataSetFirm}).success(function(e){t.firms.unshift(e),t.dataSetFirm=null}).error(function(t){console.log("Błąd: "+t)}))},t.getCurrentSeeFirm=function(n){null!==n&&void 0!==n&&o!==n&&e.getOneFirm(n).success(function(e){t.firms.currenteSeeFirmID===n&&(o=n,t.firms.currenteSeeFirm=e)}).error(function(t){console.log("Błąd: "+t)})}}else n.path("/login")}]),angular.module("VatApp").controller("InvoiceCtrl",["$scope","InvoiceSvc","$location","$window",function(t,e,n,a){if(a.localStorage.getItem("Token_jwt")){var o,r;e.getAllFirm().success(function(e){t.firms?t.firms=t.firms.concat(e):t.firms=e}).error(function(t){console.log("Błąd: "+t)}),t.getCurrentDealer=function(n){null!==n&&void 0!==n&&o!==n&&e.getOneFirm(n).success(function(e){t.firms.currentDealerID===n&&(o=n,t.firms.currentDealer=e)}).error(function(t){console.log("Błąd: "+t)})},t.getCurrentBuyer=function(n){null!==n&&void 0!==n&&r!==n&&e.getOneFirm(n).success(function(e){t.firms.currentBuyerID===n&&(r=n,t.firms.currentBuyer=e)}).error(function(t){console.log("Błąd: "+t)})},t.invoiceFinishStep1=function(t,e){n.path("/invoice/2/"+t+"/"+e)}}else n.path("/login")}]),angular.module("VatApp").controller("InvoiceStep2Ctrl",["$scope","$routeParams","InvoiceSvc","ItemsSvc","$location","$window",function(t,e,n,a,o,r){if(r.localStorage.getItem("Token_jwt")){void 0===t.firms&&(t.firms=[]),void 0===t.dataSet&&(t.dataSet=[]),n.initStep2(e.dId,e.bId).success(function(e){t.firms.currentDealer=e.dealer,t.firms.currentBuyer=e.buyer}).error(function(t){console.log("Błąd: "+t)}),a.fetch().success(function(e){t.dataSet.AddedProd=e}).error(function(t){console.log("Błąd: "+t)}),t.deleteItem=function(e){a.deleteItem(e).success(function(e){a.fetch().success(function(e){t.dataSet.AddedProd=e}).error(function(t){console.log("Błąd: "+t)})}).error(function(t){console.log("Błąd: "+t)})},t.addItem=function(){if(i){t.dataSet.prod.priceFullN=t.dataSet.prod.count*t.dataSet.prod.priceOneN;var e=l(t.dataSet.prod.taxRate);e!==!1?(e=t.dataSet.prod.priceOneN*e,t.dataSet.prod.taxFullRate=e,t.dataSet.prod.priceFullN=t.dataSet.prod.priceOneN*t.dataSet.prod.count,t.dataSet.prod.endPrice=(t.dataSet.prod.priceOneN+e)*t.dataSet.prod.count,a.create({body:t.dataSet.prod}).success(function(e){t.dataSet.AddedProd.unshift(e),t.dataSet.prod=null})):t.dataSet.prod.errorMsg="Podana stawka podatku VAT niepoprawna!"}};var l=function(t){return void 0!==t&&(0===t||"0"===t?0:t/100)},i=function(){return t.dataSet.prod&&t.dataSet.prod.name&&t.dataSet.prod.mj&&t.dataSet.prod.count&&t.dataSet.prod.priceOneN&&t.dataSet.prod.taxRate?angular.isNumber(t.dataSet.prod.count)&&angular.isNumber(t.dataSet.prod.priceOneN)&&angular.isNumber(t.dataSet.prod.taxRate)?(t.dataSet.prod.errorMsg&&(t.dataSet.prod.errorMsg=!1),!0):(t.dataSet.prod.errorMsg="Pola od 3 do 6 muszą być numeryczne!",!1):(t.dataSet.prod.errorMsg="Uzupełnij wszystkie dane!",!1)}}else o.path("/login")}]),angular.module("VatApp").controller("InvoiceStep3Ctrl",["$scope","$routeParams","$filter","$location","$window","InvoiceSvc","ItemsSvc",function(t,e,n,a,o,r,l){if(o.localStorage.getItem("Token_jwt")){void 0===t.firms&&(t.firms=[]),void 0===t.dataSet&&(t.dataSet=[],t.dataSet.dateOfIssue=new Date,t.dataSet.dateOfSell=new Date,t.dataSet.payTerm=new Date),r.initStep2(e.dId,e.bId).success(function(e){t.firms.currentDealer=e.dealer,t.firms.currentBuyer=e.buyer}).error(function(t){console.log("Błąd: "+t)}),l.fetch().success(function(e){t.dataSet.AddedProd=e,i(t.dataSet.AddedProd)}).error(function(t){console.log("Błąd: "+t)});var i=function(e){t.dataSet.EndCalc=[];var n=({group_name:String,group_item:[]},[]);n.taxRate="",n.netto=0,n.vat=0,n.brutto=0,n.nettoFull=0,n.vatFull=0,n.bruttoFull=0,angular.forEach(e,function(t,e){n.taxRate=t.taxRate,n.netto=n.netto+Number(t.priceFullN),n.vat=n.vat+Number(t.taxFullRate),n.brutto=n.brutto+Number(t.endPrice),n.nettoFull=Number(n.netto),n.vatFull=Number(n.vat),n.bruttoFull=Number(n.brutto)}),t.dataSet.EndCalc.unshift(n)};t.generateInvoice=function(){var t=[];t=c(),r.generateInvoice(t).success(function(t){a.path("/invoice/step4/"+t._id)}).error(function(t){console.log("Błąd: "+t)})};var c=function(){var e=[];return e.invoice_number=t.dataSet.invoiceNum,e.issue_date=t.dataSet.dateOfIssue,e.sell_date=t.dataSet.dateOfSell,e.company_sell=t.firms.currentDealer._id,e.company_buy=t.firms.currentBuyer._id,e.invoice_items=t.dataSet.AddedProd,"1"===t.dataSet.payForm?e.pay_by="Przelew":"2"===t.dataSet.payForm?e.pay_by="Gotówka":"3"===t.dataSet.payForm&&(e.pay_by="Karta płatnicza"),e.days_to_pay=t.dataSet.dayToPay,e.pay_date=t.dataSet.payTerm,e.all_to_pay=n("number")(t.dataSet.EndCalc[0].bruttoFull,2),e.pay_in_words="unsuported",e.paid=n("number")(t.dataSet.payed,2),e.left_to_pay=n("number")(t.dataSet.toPay,2),e}}else a.path("/login")}]),angular.module("VatApp").controller("InvoiceStep4Ctrl",["$scope","$routeParams","$filter","InvoiceSvc","ItemsSvc","$location","$window",function(t,e,n,a,o,r,l){if(l.localStorage.getItem("Token_jwt")){void 0===t.firms&&(t.firms=[]),void 0===t.dataSet&&(t.dataSet=[]),a.getInvoice(e.iId).success(function(e){t.dataSet.invoice=e,t.dataSet.AddedProd=e.invoice_items,i(t.dataSet.AddedProd),a.initStep2(e.company_sell,e.company_buy).success(function(e){t.firms.currentDealer=e.dealer,t.firms.currentBuyer=e.buyer,t.dataSet.invoice.comments="",t.dataSet.invoice.papperType="ORYGINAŁ",s()}).error(function(t){console.log("Błąd: "+t)})}).error(function(t){console.log("Błąd: "+t)});var i=function(e){t.dataSet.EndCalc=[];var n=({group_name:String,group_item:[]},[]);n.taxRate="",n.netto=0,n.vat=0,n.brutto=0,n.nettoFull=0,n.vatFull=0,n.bruttoFull=0,angular.forEach(e,function(t,e){n.taxRate=t.taxRate,n.netto=n.netto+Number(t.priceFullN),n.vat=n.vat+Number(t.taxFullRate),n.brutto=n.brutto+Number(t.endPrice),n.nettoFull=Number(n.netto),n.vatFull=Number(n.vat),n.bruttoFull=Number(n.brutto)}),t.dataSet.EndCalc.unshift(n)};t.generatePDF=function(){t.dd.content[0].columns[1].text[4].text="ORYGINAŁ",pdfMake.createPdf(t.dd).open()},t.generatePDFCopy=function(){t.dd.content[0].columns[1].text[4].text="KOPIA",pdfMake.createPdf(t.dd).open()};var c=function(){angular.forEach(t.dataSet.AddedProd,function(e,a){t.dd.content[6].table.body.push([a+1,e.name,e.mj,e.count,e.priceOneN,n("number")(e.priceFullN,2),e.taxRate,n("number")(e.taxFullRate,2),n("number")(e.endPrice,2)])}),angular.forEach(t.dataSet.EndCalc,function(e,a){t.dd.content[7].columns[1].table.body.push(["Stawka "+e.taxRate+"%",n("number")(e.netto,2),n("number")(e.vat,2),n("number")(e.brutto,2)])}),t.dd.content[7].columns[1].table.body.push(["Razem",n("number")(t.dataSet.EndCalc[0].nettoFull,2),n("number")(t.dataSet.EndCalc[0].vatFull,2),n("number")(t.dataSet.EndCalc[0].bruttoFull,2)])},s=function(){t.dd={footer:{columns:[{text:"VatApp version: 1.5.0",style:"add_v"},{text:"Thulusoftware.com",style:"add_v"},{text:"Strona: 1 z 1",style:"foot"}]},content:[{columns:[{text:["\n \n",{text:"Data wystawienia: "+moment(t.dataSet.invoice.issue_date).format("DD/MM/YYYY"),style:"data"},"\n \n",{text:"Data sprzedaży: "+moment(t.dataSet.invoice.sell_date).format("DD/MM/YYYY"),style:"data"}]},{text:[{text:"FAKTURA VAT",style:"head_fakt"},"\n \n",{text:"NR: "+t.dataSet.invoice.invoice_number,style:"nr_f"},"\n \n",{text:t.dataSet.invoice.papperType,style:"nr_f",bold:!0}]},{}]},{text:"_______________________________________________________________________________________\n",style:"nr_f"},{columns:[{text:["\n",{text:"SPRZEDAWCA:\n\n",style:"head_nazw"},{text:t.firms.currentDealer.company_name},{text:"\n\nNIP: ",style:"dane_f_h"},{text:t.firms.currentDealer.company_nip,style:"dane_f"},{text:"\nTelefon: ",style:"dane_f_h"},{text:t.firms.currentDealer.company_tel_num,style:"dane_f"},{text:"\nAdres: ",style:"dane_f_h"},{text:t.firms.currentDealer.company_adress,style:"dane_f"}]},{text:["\n",{text:"NABYWCA:\n\n",style:"head_nazw"},{text:t.firms.currentBuyer.company_name},{text:"\n\nNIP: ",style:"dane_f_h"},{text:t.firms.currentBuyer.company_nip,style:"dane_f"},{text:"\nTelefon: ",style:"dane_f_h"},{text:t.firms.currentBuyer.company_tel_num,style:"dane_f"},{text:"\nAdres: ",style:"dane_f_h"},{text:t.firms.currentBuyer.company_adress,style:"dane_f"}]}]},{text:"_______________________________________________________________________________________\n\n",style:"nr_f"},{columns:[{text:[{text:"Forma płatności: ",style:"term_h"},{text:t.dataSet.invoice.pay_by,style:"term"}]},{text:[{text:"Ilość dni do zapłaty: ",style:"term_h"},{text:t.dataSet.invoice.days_to_pay,style:"term"}]},{text:[{text:"Termin płatności: ",style:"term_h"},{text:moment(t.dataSet.invoice.pay_date).format("DD/MM/YYYY"),style:"term"}]}]},{text:["\n"]},{style:"tableExample",table:{headerRows:1,body:[[{text:"Lp.",style:"tableHeader"},{text:"Nazwa towaru lub usługi",style:"tableHeader"},{text:"J.M.",style:"tableHeader"},{text:"Ilość / Zakres",style:"tableHeader"},{text:"Cena jednostkowa netto",style:"tableHeader"},{text:"Cena całkowita netto",style:"tableHeader"},{text:"Stawka podatku VAT",style:"tableHeader"},{text:"Kwota podatku VAT",style:"tableHeader"},{text:"Cena całkowita brutto",style:"tableHeader"}]]},layout:{hLineWidth:function(t,e){return 0===t||t===e.table.body.length,1},vLineWidth:function(t,e){return 0===t||t===e.table.widths.length,1},hLineColor:function(t,e){return 0===t||t===e.table.body.length?"black":"gray"},vLineColor:function(t,e){return 0===t||t===e.table.widths.length?"black":"gray"}}},{columns:[{text:[{text:"Razem do zapłaty: ",style:"term_h"},{text:t.dataSet.invoice.all_to_pay+" PLN",style:"term"},{text:"\n\nZapłacono: ",style:"term_h"},{text:t.dataSet.invoice.paid+" PLN",style:"term"},{text:"\n\nPozostało do zapłaty: ",style:"term_h"},{text:t.dataSet.invoice.left_to_pay+" PLN",style:"term"}]},{style:"tableResult",table:{body:[[{text:"PLN",style:"tableHeader"},{text:"Wartość netto",style:"tableHeader"},{text:"Wartość VAT",style:"tableHeader"},{text:"Wartość brutto",style:"tableHeader"}]]}}]},{text:"_______________________________________________________________________________________\n\n",style:"nr_f"},{text:"Uwagi: \n"+t.dataSet.invoice.comments,style:"term_h"},{text:"\n\n"},{columns:[{text:[{text:"\n\n............................................\n\n",style:"nr_f"},{text:"Podpis osoby upoważnionej do odbioru faktury",style:"podpis_o"}]},{},{text:[{text:"\n\n............................................\n\n",style:"nr_f"},{text:"Podpis osoby upoważnionej do wystawienia faktury",style:"podpis_o"}]}]}],styles:{nr_f:{fontSize:10,alignment:"center"},head_fakt:{fontSize:20,alignment:"center",bold:!0},head_nazw:{fontSize:7,bold:!0},data:{fontSize:10},term_h:{fontSize:7},term:{fontSize:8,bold:!0},dane_f:{fontSize:10},dane_f_h:{fontSize:10,bold:!0},header:{fontSize:18,bold:!0},tableHeader:{bold:!0,alignment:"center",fontSize:7,color:"black"},tableExample:{margin:[0,5,0,15],fontSize:7,alignment:"center"},tableResult:{margin:[0,5,0,15],fontSize:7,alignment:"center"},foot:{alignment:"right",margin:[0,0,30,0],fontSize:10},bigger:{fontSize:15,italics:!0},add_v:{fontSize:8,alignment:"center"},podpis_o:{fontSize:5,alignment:"center"}},defaultStyle:{columnGap:20}},c()}}else r.path("/login")}]),angular.module("VatApp").controller("LoginCtrl",["$scope","UserSvc","$location","$window",function(t,e,n,a){a.localStorage.getItem("Token_jwt")&&(t.msgWar=!0),t.login=function(a,o){e.login(a,o).then(function(e){t.msgErrLog=null,t.$emit("login",e.data),n.path("/")}),t.msgErrLog=!0}}]),angular.module("VatApp").controller("PostsCtrl",["$scope","PostsSvc",function(t,e){e.fetch().success(function(e){t.posts=e}).error(function(t){}),t.addPost=function(){t.currentUser&&t.postTresc&&e.create({tresc:t.postTresc}).success(function(e){t.posts.unshift(e),t.postTresc=null})}}]),angular.module("VatApp").controller("RegisterCtrl",["$scope","UserSvc","$location",function(t,e,n){t.createUser=function(a,o,r){o!==r?t.msgErrPass=!0:(t.msgErrPass=null,e.createUser(a,o,r).then(function(e){t.$emit("login",e.data),n.path("/")}))}}]),angular.module("VatApp").controller("UsersCtrl",["$scope","UserSvc","$window","$location",function(t,e,n,a){n.localStorage.getItem("Token_jwt")?(e.getAllUsers().success(function(e){t.users=e}).error(function(t){}),t.deleteUser=function(n){t.currentUser.name===n?e.deleteUser(n).then(function(n){n.msg?(console.log(n.data),t.msgErrDelUser=n.data):(e.logOut(),t.currentUser=null,console.log(t.currentUser),location.reload())}):e.deleteUser(n).then(function(t){console.log(t),a.path("/users/")})}):a.path("/login")}]),angular.module("VatApp").service("CompSvc",["$http","$window",function(t,e){var n=this;n.setAuthHeaders=function(e){t.defaults.headers.common["X-Auth"]=e},n.createCompany=function(e){return t.post("/api/firm/",e)},n.getAllCompany=function(){return t.get("/api/firm/all")},n.getOneFirm=function(e){return t.get("/api/firm/GetOne/"+e)},this.deleteFirm=function(e){return t.post("/api/firm/delete/",e)}}]),angular.module("VatApp").service("InvoiceSvc",["$http","$window",function(t,e){var n=this;n.setAuthHeaders=function(e){t.defaults.headers.common["X-Auth"]=e},n.getAllFirm=function(){return t.get("/api/firm/all/")},n.getOneFirm=function(e){return t.get("/api/firm/GetOne/"+e)},n.initStep2=function(e,n){return t.get("/api/firm/StepTwo/"+e+"/"+n)},n.generateInvoice=function(e){return t.post("/api/invoices/",{invoice_number:e.invoice_number,issue_date:e.issue_date,sell_date:e.sell_date,company_sell:e.company_sell,company_buy:e.company_buy,invoice_items:e.invoice_items,pay_by:e.pay_by,days_to_pay:e.days_to_pay,pay_date:e.pay_date,all_to_pay:e.all_to_pay,pay_in_words:e.pay_in_words,paid:e.paid,left_to_pay:e.left_to_pay})},n.getInvoice=function(e){return t.get("/api/invoices/GetOne/"+e)}}]),angular.module("VatApp").service("ItemsSvc",["$http",function(t){this.fetch=function(){return t.get("/api/items/all/")},this.create=function(e){return t.post("/api/items",e)},this.deleteItem=function(e){return t.post("/api/items/delete/",{itemId:e})}}]),angular.module("VatApp").service("PostsSvc",["$http",function(t){this.fetch=function(){return t.get("/api/posts")},this.create=function(e){return t.post("/api/posts",e)}}]),angular.module("VatApp").service("UserSvc",["$http","$window","$location",function(t,e,n){var a=this;a.getUser=function(){return t.get("/api/users")},a.getAllUsers=function(){return t.get("/api/users/all")},a.setAuthHeaders=function(e){t.defaults.headers.common["X-Auth"]=e},a.getLogUser=function(t){return a.setAuthHeaders(t),a.getUser()},a.login=function(n,o){return t.post("/api/sessions",{name:n,pass:o}).then(function(t){return a.setAuthHeaders(e.localStorage.Token_jwt=t.data),a.getUser()})},a.createUser=function(e,n){return t.post("/api/users",{name:e,pass:n}).then(function(t,o,r){return o?r(o):a.login(e,n)})},a.deleteUser=function(e){return t.post("/api/users/delete",{name:e}).then(function(t){return t.data})},a.logOut=function(){e.localStorage.removeItem("Token_jwt"),n.path("/")}}]);